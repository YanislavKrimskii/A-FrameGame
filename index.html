<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.4.0/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.1/aframe/build/aframe-ar.min.js"></script>
    <style>
        /* –≠–∫—Ä–∞–Ω –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–º–µ—Ä—ã */
        .permission-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            text-align: center;
            padding: 20px;
        }
        .permission-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 18px 36px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .permission-btn:hover { background: #2980b9; transform: scale(1.05); }
        .permission-btn:disabled { background: #7f8c8d; cursor: not-allowed; }
        .error-message {
            color: #e74c3c;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            background: rgba(231, 76, 60, 0.1);
            max-width: 500px;
        }
        
        /* –õ–æ–∞–¥–µ—Ä */
        .arjs-loader {
            height: 100vh; width: 100%;
            position: fixed; top: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            flex-direction: column;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å AR */
        .hint {
            position: fixed;
            top: 20px; left: 0;
            width: 100%;
            text-align: center;
            z-index: 100;
            color: white;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #3498db;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 100;
            gap: 10px;
            padding: 0 10px;
        }
        .control-btn {
            background: rgba(52, 152, 219, 0.9);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            min-width: 120px;
            backdrop-filter: blur(10px);
        }
        .control-btn:hover {
            background: rgba(41, 128, 185, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* –£—Ç–∏–ª–∏—Ç—ã */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 1. –≠–ö–†–ê–ù –ó–ê–ü–†–û–°–ê –ö–ê–ú–ï–†–´ -->
    <div class="permission-screen" id="cameraPermission">
        <h1>üï∂Ô∏è AR –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h1>
        <p>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–π –∫–∞–º–µ—Ä–µ</p>
        <p><small>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –æ–∫–Ω–µ –±—Ä–∞—É–∑–µ—Ä–∞</small></p>
        
        <!-- –ö–Ω–æ–ø–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç getUserMedia() -->
        <button class="permission-btn" id="requestCameraBtn">
            üîì –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        </button>
        
        <div id="cameraError" class="error-message hidden"></div>
    </div>

    <!-- 2. –õ–û–ê–î–ï–† (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è) -->
    <div class="arjs-loader hidden" id="loader">
        <div class="loader"></div>
        <h1>–ó–∞–ø—É—Å–∫ AR...</h1>
    </div>

    <!-- 3. –ü–û–î–°–ö–ê–ó–ö–ê -->
    <div class="hint hidden" id="hint">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä</div>

    <!-- 4. AR-–°–¶–ï–ù–ê (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞ –∏ –±–µ–∑ arjs) -->
    <a-scene 
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
        embedded
        class="hidden"
        id="arScene">
        
        <!-- ‚ö†Ô∏è –í–ê–ñ–ù–û: –∑–∞–º–µ–Ω–∏—Ç–µ 'markers/target.patt' –Ω–∞ –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É .patt —Ñ–∞–π–ª—É -->
        <a-marker 
            id="customMarker"
            type='pattern' 
            url='markers/target.patt'
            emitevents="true"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2">
            
            <!-- ‚ö†Ô∏è –í–ê–ñ–ù–û: –∑–∞–º–µ–Ω–∏—Ç–µ '#myModel' –∏ 'models/model.glb' –Ω–∞ –≤–∞—à—É –º–æ–¥–µ–ª—å -->
            <a-entity 
                id="customModel"
                gltf-model="#myModel" 
                position="0 0.5 0"
                scale="0.1 0.1 0.1"
                rotation="0 0 0"
                animation-mixer="clip: *; loop: repeat">
            </a-entity>

            <!-- ‚ö†Ô∏è –í–ê–ñ–ù–û: –∑–∞–º–µ–Ω–∏—Ç–µ '#appearSound' –∏ 'sounds/sound.mp3' –Ω–∞ –≤–∞—à –∑–≤—É–∫ -->
            <a-entity
                id="appearSoundEntity"
                sound="src: #appearSound; autoplay: false; volume: 0.5">
            </a-entity>

            <a-light type="ambient" color="#FFF" intensity="0.6"></a-light>
            <a-light type="directional" color="#FFF" intensity="0.8" position="-1 2 1"></a-light>
        </a-marker>

        <a-entity camera></a-entity>

        <!-- –†–µ—Å—É—Ä—Å—ã -->
        <a-assets timeout="100000">
            <a-asset-item id="myModel" src="models/model.glb"></a-asset-item>
            <audio id="appearSound" src="sounds/sound.mp3" preload="auto"></audio>
        </a-assets>
    </a-scene>

    <!-- 5. –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
    <div class="controls hidden" id="controls">
        <button class="control-btn" id="scaleUpBtn">–£–≤–µ–ª–∏—á–∏—Ç—å</button>
        <button class="control-btn" id="scaleDownBtn">–£–º–µ–Ω—å—à–∏—Ç—å</button>
        <button class="control-btn" id="rotateBtn">–í—Ä–∞—â–∞—Ç—å</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const cameraPermission = document.getElementById('cameraPermission');
            const requestCameraBtn = document.getElementById('requestCameraBtn');
            const cameraError = document.getElementById('cameraError');
            const loader = document.getElementById('loader');
            const hint = document.getElementById('hint');
            const arScene = document.getElementById('arScene');
            const controls = document.getElementById('controls');
            
            // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
            requestCameraBtn.addEventListener('click', async function() {
                try {
                    // –ú–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
                    requestCameraBtn.disabled = true;
                    requestCameraBtn.textContent = '–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...';
                    cameraError.classList.add('hidden');
                    
                    // –í–´–ó–û–í –ë–†–ê–£–ó–ï–†–ù–û–ì–û API getUserMedia()
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    // –£—Å–ø–µ—Ö: —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
                    cameraPermission.classList.add('hidden');
                    loader.classList.remove('hidden');
                    
                    // –¢–ï–ü–ï–†–¨ –¥–æ–±–∞–≤–ª—è–µ–º AR.js –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ü–µ–Ω—É
                    arScene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false;');
                    arScene.classList.remove('hidden');
                    
                    // –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                    setTimeout(initARScene, 100);
                    
                } catch (error) {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–∞–º–µ—Ä—ã
                    console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                    requestCameraBtn.disabled = false;
                    requestCameraBtn.textContent = '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
                    
                    // –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                    if (error.name === 'NotAllowedError') {
                        cameraError.textContent = '–í—ã –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                    } else if (error.name === 'NotFoundError') {
                        cameraError.textContent = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.';
                    } else if (error.name === 'NotReadableError') {
                        cameraError.textContent = '–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                    } else {
                        cameraError.textContent = '–û—à–∏–±–∫–∞: ' + error.message;
                    }
                    cameraError.classList.remove('hidden');
                }
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR-—Å—Ü–µ–Ω—ã –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
            function initARScene() {
                arScene.addEventListener('loaded', function() {
                    setTimeout(() => {
                        loader.classList.add('hidden');
                        hint.classList.remove('hidden');
                        controls.classList.remove('hidden');
                    }, 1000);
                });
                
                // –≠–ª–µ–º–µ–Ω—Ç—ã AR
                const marker = document.querySelector('#customMarker');
                const soundEntity = document.querySelector('#appearSoundEntity');
                const model = document.querySelector('#customModel');
                const scaleUpBtn = document.getElementById('scaleUpBtn');
                const scaleDownBtn = document.getElementById('scaleDownBtn');
                const rotateBtn = document.getElementById('rotateBtn');
                
                let isRotating = false;
                let rotationInterval = null;
                let currentScale = 0.1;
                
                // –°–æ–±—ã—Ç–∏—è –º–∞—Ä–∫–µ—Ä–∞
                if (marker) {
                    marker.addEventListener('markerFound', function() {
                        hint.textContent = '–ú–∞—Ä–∫–µ—Ä –Ω–∞–π–¥–µ–Ω!';
                        hint.style.color = '#2ecc71';
                        
                        // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∑–≤—É–∫ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏
                        try {
                            if (soundEntity && soundEntity.components.sound) {
                                soundEntity.components.sound.playSound();
                            }
                        } catch (e) {
                            console.log('–ó–≤—É–∫:', e.message);
                        }
                    });
                    
                    marker.addEventListener('markerLost', function() {
                        hint.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä';
                        hint.style.color = 'white';
                    });
                }
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—å—é
                scaleUpBtn.addEventListener('click', function() {
                    currentScale += 0.02;
                    if (model) {
                        model.setAttribute('scale', {
                            x: currentScale, y: currentScale, z: currentScale
                        });
                    }
                });
                
                scaleDownBtn.addEventListener('click', function() {
                    currentScale -= 0.02;
                    if (currentScale < 0.02) currentScale = 0.02;
                    if (model) {
                        model.setAttribute('scale', {
                            x: currentScale, y: currentScale, z: currentScale
                        });
                    }
                });
                
                rotateBtn.addEventListener('click', function() {
                    isRotating = !isRotating;
                    
                    if (isRotating) {
                        rotateBtn.textContent = '–°—Ç–æ–ø';
                        rotationInterval = setInterval(() => {
                            if (model) {
                                const currentRotation = model.getAttribute('rotation');
                                model.setAttribute('rotation', {
                                    x: currentRotation.x,
                                    y: currentRotation.y + 2,
                                    z: currentRotation.z
                                });
                            }
                        }, 50);
                    } else {
                        rotateBtn.textContent = '–í—Ä–∞—â–∞—Ç—å';
                        if (rotationInterval) clearInterval(rotationInterval);
                    }
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                cameraError.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä —É—Å—Ç–∞—Ä–µ–ª –∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–º–µ—Ä—É.';
                cameraError.classList.remove('hidden');
                requestCameraBtn.disabled = true;
            }
        });
    </script>
</body>
</html>